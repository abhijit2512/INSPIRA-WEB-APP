<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Inspira — Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=10" />

  <!-- OPTIONAL: Desktop uploads to Azure Blob.
       Put your Azure Blob *Container SAS URL* (to your 'videos' container) here.
       Example:
       https://<storage>.blob.core.windows.net/videos?<SAS>
       Leave empty to hide the desktop file UI. -->
  <meta name="blob-container-sas" content="https://stvideosedutalk.blob.core.windows.net/videos?sp=rcw&st=2025-08-22T08:57:56Z&se=2025-08-29T17:12:56Z&spr=https&sv=2024-11-04&sr=c&sig=9kgg4AlbV3jqlJQhcIzVttFzsJy%2FYPiRLxRRpLscjlU%3D" />

  <style>
    /* Inspira look: dark + purple/gold accents */
    :root{
      --brand-bg:#0a0f20;
      --brand-card:#10172a;
      --brand-text:#e8eefc;
      --brand-muted:#9aa3b2;
      --brand-primary:#7c3aed;  /* purple */
      --brand-secondary:#253a6b;
      --brand-accent:#f59e0b;   /* gold */
      --brand-danger:#8a1a1a;
      --brand-outline:#20314f;
    }
    body{background:var(--brand-bg);color:var(--brand-text);}
    .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:#0e1530;border-bottom:1px solid #1e2a46;}
    .container{max-width:900px;margin:24px auto;padding:0 14px;}
    .card{background:var(--brand-card);border:1px solid #1e2a46;border-radius:14px;padding:16px;}
    .muted{color:var(--brand-muted)}
    .field{display:grid;gap:6px;margin:10px 0}
    .field input{padding:8px 10px;border:1px solid var(--brand-outline);background:#0a0f20;color:var(--brand-text);border-radius:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;background:var(--brand-primary);color:#fff;border:none;border-radius:8px;cursor:pointer}
    .btn.secondary{background:var(--brand-secondary)}
    .btn.danger{background:var(--brand-danger)}
    .badge{font-size:12px;padding:2px 8px;background:#13213b;color:#a9b6d3;border-radius:999px}
    .small{font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;border:1px dashed var(--brand-outline)}
    .progress-wrap{display:none;align-items:center;gap:8px}
    .progress{appearance:none;width:220px;height:10px;border-radius:999px;overflow:hidden;background:#14213d}
    .progress::-webkit-progress-bar{background:#14213d}
    .progress::-webkit-progress-value{background:#3b82f6}
    .progress::-moz-progress-bar{background:#3b82f6}
    .footer{ text-align:center; color:var(--brand-muted); padding:24px 12px; border-top:1px solid #1e2a46; margin-top:28px; }
  </style>
</head>
<body>
<header class="nav">
  <h1><a href="/" style="color:inherit;text-decoration:none">Inspira</a></h1>
  <nav style="display:flex;gap:10px;align-items:center">
    <span class="badge" id="roleBadge">Guest</span>
    <button id="btnRole"  class="btn secondary" type="button" style="display:none" title="Switch between Consumer and Creator">Switch Role</button>
    <button id="btnSignIn"  class="btn"          type="button">Sign in</button>
    <button id="btnSignOut" class="btn danger"   type="button" style="display:none">Sign out</button>
    <a class="btn secondary" href="/videos.html">All Videos</a>
  </nav>
</header>

<main class="container">
  <section class="card">
    <h2>Upload a New Video</h2>

    <!-- Only-Creator message -->
    <div id="gateMsg" class="muted" style="display:none">
      You must be signed in as <b>Creator</b> to upload. Use “Sign in”, then “Switch Role” to become a Creator.
    </div>

    <!-- Creator-only form -->
    <form id="formWrap" style="display:none;max-width:680px">
      <div class="field">
        <label>Title</label>
        <input id="title" placeholder="e.g., Algebra Basics" />
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 230px">
          <label>Publisher</label>
          <input id="publisher" placeholder="Publisher" />
        </div>
        <div class="field" style="flex:1 1 230px">
          <label>Producer</label>
          <input id="producer"  placeholder="Producer" />
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 230px">
          <label>Genre</label>
          <input id="genre"     placeholder="e.g., inspira" />
        </div>
        <div class="field" style="flex:1 1 230px">
          <label>Age Rating</label>
          <input id="age"       placeholder="e.g., 13+" />
        </div>
      </div>

      <!-- (A) Paste final playback URL (works for YouTube or public blob URLs) -->
      <div class="field">
        <label>Playback URL (YouTube link or direct MP4/WebM/Ogg URL)</label>
        <input id="playbackUrl" placeholder="https://... (YouTube or blob URL)" />
      </div>

      <!-- (B) OPTIONAL desktop upload to Azure Blob (shown only if container SAS is provided) -->
      <div id="blobArea" class="field" style="display:none">
        <label>Upload from Desktop <span class="pill small">Azure Blob</span></label>
        <div class="row">
          <input id="filePick" type="file" accept="video/*" />
          <button id="btnBlobUpload" class="btn" type="button">Upload Video File</button>
          <span id="blobStatus" class="muted small"></span>
        </div>

        <div class="progress-wrap" id="progressWrap">
          <progress id="prog" class="progress" max="100" value="0"></progress>
          <span id="progText" class="small muted">0%</span>
        </div>

        <div class="small muted">
          After upload, the <b>Playback URL</b> will be filled automatically.
          (Container access level must be <i>Blob (anonymous read access)</i>.)
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnSubmit" type="submit">Save to Inspira</button>
        <span id="status" class="muted"></span>
      </div>
    </form>
  </section>
</main>

<footer class="footer">© Inspira</footer>

<!-- MSAL -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<script>
  // ===== Auth & Role (same IDs you used on videos.html) =====
  const TENANT_ID = "b0e4c77a-c53c-4cbc-8f97-72baebc755dd";
  const CLIENT_ID = "e20305aa-c3a6-438e-80a0-6e0e92434fc2";

  const msalInstance = new msal.PublicClientApplication({
    auth:{ clientId: CLIENT_ID, authority:`https://login.microsoftonline.com/${TENANT_ID}`, redirectUri: window.location.origin },
    cache:{ cacheLocation:"localStorage" }
  });

  const LS_KEY = "INSPIRA_ID_TOKEN";
  let ID_TOKEN = localStorage.getItem(LS_KEY) || null;
  let ME = null; // {oid,email,name,role}

  function authz(extra={}) {
    const t = ID_TOKEN || localStorage.getItem(LS_KEY) || "";
    return t ? { ...extra, Authorization:`Bearer ${t}` } : extra;
  }

  async function signIn(){
    try{
      const login = await msalInstance.loginPopup({ scopes:["openid","profile","email"] });
      const token = await msalInstance.acquireTokenSilent({ account: login.account, scopes:["openid","profile","email"]});
      ID_TOKEN = token.idToken;
      localStorage.setItem(LS_KEY, ID_TOKEN);
      await refreshMe(); renderAuthUI(); gateUI();
    }catch(e){ alert("Sign in failed: "+(e.message||e)); }
  }
  async function signOut(){
    localStorage.removeItem(LS_KEY); ID_TOKEN=null; ME=null;
    try{ await msalInstance.logoutPopup(); }catch{}
    renderAuthUI(); gateUI();
  }

  async function refreshMe(){
    try{
      const res = await fetch("/me",{ headers: authz({Accept:"application/json"})});
      ME = res.ok ? (await res.json()).user : null;
    }catch{ ME=null; }
    updateRoleBadge();
  }

  function updateRoleBadge(){
    const b = document.getElementById("roleBadge");
    b.textContent = ME ? ME.role : "Guest";
    const btnRole = document.getElementById("btnRole");
    btnRole.style.display = ME ? "inline-flex" : "none";
    btnRole.textContent = ME && ME.role==="Creator" ? "Switch to Consumer" : "Switch to Creator";
  }

  async function switchRole(){
    if(!ME) return alert("Please sign in first.");
    const target = ME.role==="Creator" ? "Consumer" : "Creator";
    const res = await fetch("/me/role",{ method:"POST", headers: authz({"Content-Type":"application/json"}), body: JSON.stringify({role:target}) });
    if(!res.ok){ return alert("Role change failed: "+(await res.text()).slice(0,200)); }
    await refreshMe(); gateUI();
  }

  function renderAuthUI(){
    const signed = !!(ID_TOKEN || localStorage.getItem(LS_KEY));
    document.getElementById("btnSignIn").style.display  = signed ? "none" : "inline-flex";
    document.getElementById("btnSignOut").style.display = signed ? "inline-flex" : "none";
    updateRoleBadge();
  }

  function gateUI(){
    const isCreator = !!(ME && ME.role==="Creator");
    document.getElementById("formWrap").style.display = isCreator ? "block" : "none";
    document.getElementById("gateMsg").style.display  = isCreator ? "none"  : "block";
  }

  // ===== Desktop upload to Azure Blob (via Container SAS) =====
  const containerSas = (document.querySelector('meta[name="blob-container-sas"]')?.content || '').trim();
  const blobArea = document.getElementById("blobArea");
  if (containerSas && /^https?:\/\//i.test(containerSas)) {
    blobArea.style.display = "block";
  }

  function parseContainerInfo(containerSasUrl){
    // Example: https://<account>.blob.core.windows.net/videos?<SAS>
    try{
      const u = new URL(containerSasUrl);
      const account = u.hostname.split('.')[0];
      const container = u.pathname.replace(/^\//,'').split('/')[0];
      const qs = u.search; // includes leading '?'
      const base = `https://${account}.blob.core.windows.net/${container}`;
      return { account, container, query: qs, base };
    }catch{
      return null;
    }
  }

  // PUT with progress (XMLHttpRequest so we can track upload progress)
  function putWithProgress(url, file, headers = {}, onProgress = ()=>{}){
    return new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open("PUT", url, true);
      Object.entries(headers).forEach(([k,v])=>xhr.setRequestHeader(k, v));
      xhr.upload.onprogress = (evt)=>{
        if (evt.lengthComputable){
          const pct = Math.round((evt.loaded/evt.total)*100);
          onProgress(pct);
        }
      };
      xhr.onload = ()=> (xhr.status >= 200 && xhr.status < 300) ? resolve(xhr.responseText) : reject(new Error(`Blob upload failed: ${xhr.status} ${xhr.statusText}`));
      xhr.onerror = ()=> reject(new Error("Network error during blob upload"));
      xhr.send(file);
    });
  }

  async function uploadToBlobWithSas(file, onProgress){
    const info = parseContainerInfo(containerSas);
    if (!info) throw new Error("Invalid container SAS URL.");
    const safeName = Date.now() + "_" + file.name.replace(/[^\w.\- ]+/g,'_'); // prefix to avoid collisions
    const putUrl = `${info.base}/${encodeURIComponent(safeName)}${info.query}`;
    await putWithProgress(
      putUrl,
      file,
      {
        "x-ms-blob-type": "BlockBlob",
        "x-ms-version": "2021-12-02",
        "Content-Type": file.type || "application/octet-stream"
      },
      onProgress
    );
    // Public (read) URL (container must allow Blob anonymous read)
    return `${info.base}/${encodeURIComponent(safeName)}`;
  }

  // ===== Save metadata to Inspira (Creator only) =====
  async function submitForm(e){
    e.preventDefault();
    const status = document.getElementById("status");
    status.textContent = "";

    if(!ME || ME.role!=="Creator"){
      status.textContent = "You must be Creator to upload.";
      return;
    }
    const body = {
      title:       document.getElementById("title").value.trim(),
      publisher:   document.getElementById("publisher").value.trim(),
      producer:    document.getElementById("producer").value.trim(),
      genre:       document.getElementById("genre").value.trim(),
      age:         document.getElementById("age").value.trim(),
      playbackUrl: document.getElementById("playbackUrl").value.trim(),
      external:    true
    };
    if(!body.title || !body.playbackUrl){
      status.textContent = "Title and Playback URL are required.";
      return;
    }

    try{
      document.getElementById("btnSubmit").disabled = true;
      status.textContent = "Saving…";
      const res = await fetch("/videos",{
        method:"POST",
        headers: { ...authz({"Content-Type":"application/json"}) },
        body: JSON.stringify(body)
      });
      const txt = await res.text();
      if(!res.ok){
        status.textContent = `Save failed: ${res.status} ${res.statusText} — ${(txt||"").slice(0,180)}`;
        return;
      }
      status.textContent = "Saved ✓ (view it in All Videos)";
      // window.location.href = "/videos.html";
    }catch(e){
      status.textContent = "Save error: "+e.message;
    }finally{
      document.getElementById("btnSubmit").disabled = false;
    }
  }

  // ===== Bootstrap =====
  (async ()=>{
    renderAuthUI();
    if(ID_TOKEN) await refreshMe();
    gateUI();

    document.getElementById("btnSignIn").addEventListener("click", signIn);
    document.getElementById("btnSignOut").addEventListener("click", signOut);
    document.getElementById("btnRole").addEventListener("click", switchRole);
    document.getElementById("formWrap").addEventListener("submit", submitForm);

    if (blobArea.style.display !== "none") {
      const filePick   = document.getElementById("filePick");
      const blobStatus = document.getElementById("blobStatus");
      const prog       = document.getElementById("prog");
      const progWrap   = document.getElementById("progressWrap");
      const progText   = document.getElementById("progText");

      document.getElementById("btnBlobUpload").addEventListener("click", async ()=>{
        const file = filePick.files?.[0];
        if (!file) { blobStatus.textContent = "Choose a file first."; return; }
        if (!ME || ME.role !== "Creator"){ blobStatus.textContent = "Sign in as Creator to upload."; return; }

        try{
          blobStatus.textContent = "Uploading to Azure Blob…";
          progWrap.style.display = "flex";
          prog.value = 0; progText.textContent = "0%";

          const url = await uploadToBlobWithSas(file, (pct)=>{
            prog.value = pct; progText.textContent = pct + "%";
          });

          // Fill playback URL with the public blob URL
          document.getElementById("playbackUrl").value = url;

          // If title empty, prefill from filename (without extension)
          const titleEl = document.getElementById("title");
          if (!titleEl.value.trim()){
            const base = (file.name || "").split('.').slice(0,-1).join('.') || file.name;
            titleEl.value = base.replace(/[_\-]+/g,' ').trim();
          }

          blobStatus.textContent = "Uploaded ✓ (click Save to publish)";
        }catch(e){
          blobStatus.textContent = e.message;
        }finally{
          setTimeout(()=>{ progWrap.style.display = "none"; }, 800);
        }
      });
    }
  })();
</script>
</body>
</html>
